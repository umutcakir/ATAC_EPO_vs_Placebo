library(Signac)
library(Seurat)
library(EnsDb.Mmusculus.v79)
library(ggplot2)
library(patchwork)
library(GenomicRanges)
library(future)
library(harmony)
library(AtacAnnoR) 
library(presto)
set.seed(0)
 
main_current_wd_dir = getwd()

file_names <- c("A1", "A2", "A4", "A6", "B7", "B8", "B9", "B11")
#Creating a common peak set
setwd("../")

for (name in file_names) {
  assign(paste("peaks.", name, sep = ""), makeGRangesFromDataFrame(read.table(
    file = paste("./counts/Hipp-", name, "/Hipp-", name, "/outs/peaks.bed", sep = ""),
    col.names = c("chr", "start", "end")
  )))
}


# Create a unified set of peaks to quantify in each dataset
combined.peaks <- reduce(x = c(peaks.A1, peaks.A2, peaks.A4, peaks.A6,
                               peaks.B7, peaks.B8, peaks.B9, peaks.B11))

# Filter out bad peaks based on length
peakwidths <- width(combined.peaks)
combined.peaks <- combined.peaks[peakwidths  < 10000 & peakwidths > 20]
combined.peaks

#Create Fragment objects

# load metadata
for (name in file_names) {
  assign(paste("md.", name, sep = ""), read.table(
    file = paste("./counts/Hipp-", name, "/Hipp-", name, "/outs/singlecell.csv", sep = ""),
    stringsAsFactors = FALSE,
    sep = ",",
    header = TRUE,
    row.names = 1
  )[-1, ])
}

# perform an initial filtering of low count cells
for (name in file_names) {
  assign(paste("md.", name, sep = ""), get(paste("md.", name, sep = ""))[get(paste("md.", name, sep = ""))$passed_filters > 500, ])
}


# create fragment objects
for (name in file_names) {
  assign(paste("frags.", name, sep = ""), CreateFragmentObject(
    path = paste("./counts/Hipp-", name, "/Hipp-", name, "/outs/fragments.tsv.gz", sep = ""),
    cells = rownames(get(paste("md.", name, sep = "")))
  ))
}

# Quantify peaks in each dataset
for (name in file_names) {
  assign(paste(name, ".counts", sep = ""), FeatureMatrix(
    fragments = get(paste("frags.", name, sep = "")),
    features = combined.peaks,
    cells = rownames(get(paste("md.", name, sep = "")))
  ))
}


# Create the objects

for (name in file_names) {
  counts <- get(paste(name, ".counts", sep = ""))
  frags <- get(paste("frags.", name, sep = ""))
  md <- get(paste("md.", name, sep = ""))
  
  assay <- CreateChromatinAssay(counts, fragments = frags)
  assign(paste(name, "_assay", sep = ""), assay)
  
  seurat_obj <- CreateSeuratObject(assay, assay = "peaks", meta.data = md, project = name)
  assign(name, seurat_obj)
}

annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)

# change to UCSC style since the data was mapped to mm10
seqlevels(annotations) <- paste0('chr', seqlevels(annotations))
genome(annotations) <- "mm10"

# Loop over each object
for (name in file_names) {
  # Retrieve the Seurat object
  current_object <- get(name)
  
  # Add gene information to the object
  Annotation(current_object) <- annotations
  
  # Compute nucleosome signal score per cell
  current_object <- NucleosomeSignal(object = current_object)
  
  # Compute TSS enrichment score per cell
  current_object <- TSSEnrichment(object = current_object, fast = FALSE)
  
  # Compute blacklist region
  current_object$blacklist_ratio <- FractionCountsInRegion(
    object = current_object, 
    assay = 'peaks',
    regions = Signac::blacklist_mm10
  )
  
  # Compute additional metrics
  current_object@meta.data$pct_reads_in_peaks <- current_object$peak_region_fragments / current_object$passed_filters * 100 
  
  low_prf <- quantile(current_object[["peak_region_fragments"]]$peak_region_fragments, probs = 0.02)
  hig_prf <- quantile(current_object[["peak_region_fragments"]]$peak_region_fragments, probs = 0.98)
  low_prp <- quantile(current_object[["pct_reads_in_peaks"]]$pct_reads_in_peaks, probs = 0.02)
  high_blr <- quantile(current_object[["blacklist_ratio"]]$blacklist_ratio, probs = 0.98)
  hig_ns <- quantile(current_object[["nucleosome_signal"]]$nucleosome_signal, probs = 0.98)
  low_ts <- quantile(current_object[["TSS.enrichment"]]$TSS.enrichment, probs = 0.02)

  # Visualize metrics
  pdf(file = paste0(name, "_VlnPlot_before_QC.pdf"), width = 20, height = 8)
  print(VlnPlot(
    object = current_object,
    features = c('pct_reads_in_peaks', 'peak_region_fragments',
                 'TSS.enrichment', 'blacklist_ratio', 'nucleosome_signal'),
    pt.size = 0.1,
    ncol = 5
  ))
  dev.off()
  
  
  # Perform data filtering
  current_object <- subset(
    x = current_object,
    subset = peak_region_fragments > low_prf &
      peak_region_fragments < hig_prf &
      pct_reads_in_peaks > low_prp &
      blacklist_ratio < high_blr &
      nucleosome_signal < hig_ns &
      TSS.enrichment > low_ts
  )
  
  # Visualize metrics
  pdf(file = paste0(name,"_VlnPlot_after_QC.pdf"), width = 20, height = 8)
  print(VlnPlot(
    object = current_object,
    features = c('pct_reads_in_peaks', 'peak_region_fragments',
                 'TSS.enrichment', 'blacklist_ratio', 'nucleosome_signal'),
    pt.size = 0.1,
    ncol = 5
  ))
  dev.off()
  
  # Update the Seurat object in the environment
  assign(name, current_object)
}


# add information to identify dataset of origin
for (name in file_names) {
  # Retrieve the Seurat object
  current_object <- get(name)
  
  # Assign dataset information
  current_object$dataset <- name
  
  # Update the Seurat object in the environment
  assign(name, current_object)
}

# merge all datasets, adding a cell ID to make sure cell names are unique
combined <- merge(
  x = A1,
  y = list(A2, A4, A6, B7, B8, B9, B11),
  add.cell.ids = c("A1", "A2", "A4", "A6", "B7", "B8", "B9", "B11")
)


setwd(main_current_wd_dir)
saveRDS(combined, file = "combined_merged.RDS")
#saveRDS(combined, file = "_original_combined_merged.RDS")


library(Signac)
library(Seurat)
library(EnsDb.Mmusculus.v79)
library(ggplot2)
library(patchwork)
library(GenomicRanges)
library(future)
library(harmony)
library(AtacAnnoR) 
library(presto)
set.seed(0)

alldata <- readRDS(file = "combined_merged.RDS")
 
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)

# change to UCSC style since the data was mapped to mm10
seqlevels(annotations) <- paste0('chr', seqlevels(annotations))
genome(annotations) <- "mm10"

Annotation(alldata) <- annotations

alldata <- RunTFIDF(alldata)
alldata <- FindTopFeatures(alldata, min.cutoff = 20)
alldata <- RunSVD(alldata)
DepthCor(alldata)
alldata <- RunUMAP(object = alldata, reduction = 'lsi', dims = 2:30)

before_harmony <- DimPlot(alldata, label = TRUE) + ggtitle("scATAC-seq (Unintegrated)")

alldata <- RunHarmony(object = alldata, group.by.vars = 'orig.ident', reduction.use = 'lsi', assay.use = 'peaks', project.dim = FALSE)
alldata <- RunUMAP(alldata, dims = 2:30, reduction = 'harmony')

after_harmony <- DimPlot(alldata, label = TRUE) + ggtitle("scATAC-seq (Integrated using Harmony)")
before_harmony | after_harmony

combined_plot <- before_harmony | after_harmony

ggsave("UMAP_before_after_Harmony.pdf", plot = combined_plot, width = 12, height = 6)
ggsave("UMAP_before_after_Harmony.png", plot = combined_plot, width = 12, height = 6, dpi = 600)


alldata <- FindNeighbors(
  object = alldata,
  reduction = 'lsi',
  dims = 2:30
)

alldata <- FindClusters(
  object = alldata,
  algorithm = 3,
  resolution = 0.8,
  verbose = FALSE
)

saveRDS(alldata, file = "ATAC_integrated.RDS")

DimPlot(alldata, label = TRUE)

alldata <- readRDS("ATAC_integrated.RDS")
 
gene.activities <- GeneActivity(alldata, max.width = NULL, biotypes = NULL)

alldata[['ACTIVITY']] <- CreateAssayObject(counts = gene.activities)

alldata <- NormalizeData(
  object = alldata,
  assay = 'ACTIVITY',
  normalization.method = 'LogNormalize',
  scale.factor = median(alldata$nCount_ACTIVITY)
)

saveRDS(alldata, file = "ATAC_with_ACTIVITY.RDS")

#alldata <- readRDS("ATAC_final.RDS")

# Load the pre-processed scRNA-seq data 
merged_seurat_object.RNA <- readRDS(file = "EPOsnRNA_reduced_labels.rds")
Idents(merged_seurat_object.RNA) <- merged_seurat_object.RNA@meta.data$global_identity

my_cols <- c(
  'Oligodendrocytes'='#f8766d',     # Light Red
  'Intermediate cells'='#fdbf6f',   # Orange
  'Dentate gyrus neurons'='#a6d854', # Green
  'Interneurons'='#66c2a5',         # Teal
  'Pyramidal neurons'='#8da0cb',    # Purple
  'Astrocytes'='#e78ac3',           # Pink
  'Microglia'='#a8786e',            # Brown
  'Endothelial cells'='#ffd92f',    # Yellow
  'Pericytes'='#33aaff',            # Blue
  'Ependymal cells'='#b3b3b3',      # Gray
  'Neuroimmune cells'='#800000'     # Maroon
)


DimPlot(merged_seurat_object.RNA, label = TRUE, group.by = "global_identity", raster = FALSE, cols = my_cols, repel = TRUE)
merged_seurat_object.RNA <- UpdateSeuratObject(merged_seurat_object.RNA)
DimPlot(merged_seurat_object.RNA, label = TRUE, group.by = "global_identity", raster = FALSE, cols = my_cols, repel = TRUE)
merged_seurat_object.RNA <- subset(merged_seurat_object.RNA, orig.ident != "A5")
merged_seurat_object.RNA <- subset(merged_seurat_object.RNA, orig.ident != "B12")
merged_seurat_object.RNA <- subset(merged_seurat_object.RNA, orig.ident != "A3")
merged_seurat_object.RNA <- subset(merged_seurat_object.RNA, orig.ident != "B10")

DimPlot(merged_seurat_object.RNA, label = TRUE, group.by = "global_identity")

saveRDS(merged_seurat_object.RNA, file = "RNA_final_(without_A3_A5_B10_B12).RDS")
 


library(Signac)
library(Seurat)
library(EnsDb.Mmusculus.v79)
library(ggplot2)
library(patchwork)
library(GenomicRanges)
library(future)
library(harmony)
library(AtacAnnoR) 
library(presto)
set.seed(0)


cols <- c(
  "Oligodendrocytes" = "maroon",      
  "Pyramidal neurons" = "darkcyan",      
  "Interneurons" = "gold",     
  "Intermediate cells" = "navy",    
  "Dentate gyrus neurons" = "turquoise",   
  "Astrocytes" = "blue",   
  "Microglia" = "darkorange",  
  "Endothelial cells" = "deepskyblue",     
  "Pericytes" = "purple",    
  "Ependymal cells" = "grey",     
  "Neuroimmune cells" = "violet"
)

levels <- c("Oligodendrocytes", "Pyramidal neurons", "Interneurons",
            "Intermediate cells", "Dentate gyrus neurons", "Astrocytes",
            "Microglia", "Endothelial cells", "Pericytes", "Ependymal cells",
            "Neuroimmune cells")


file_names <- c("A1", "A2", "A4", "A6", "B7", "B8", "B9", "B11")

ATAC <- readRDS("ATAC_with_ACTIVITY.RDS")
RNA <- readRDS("RNA_final_(without_A3_A5_B10_B12).RDS")

DefaultAssay(ATAC) <- "peaks"

transfer.anchors <- FindTransferAnchors(reference = RNA, query = ATAC, features = VariableFeatures(object = RNA), 
                                        reference.assay = "RNA", query.assay = "ACTIVITY", reduction = "cca")

saveRDS(transfer.anchors, file = "transfer.anchors.RDS")

celltype.predictions <- TransferData(anchorset = transfer.anchors, refdata = RNA$global_identity, 
                                     weight.reduction = ATAC[["lsi"]], dims = 2:30)

ATAC <- AddMetaData(ATAC, metadata = celltype.predictions)

ATAC$predicted.id <- factor(ATAC$predicted.id, levels = levels)
Idents(ATAC) <- "predicted.id"
DimPlot(ATAC, group.by = "predicted.id", cols = cols, label = TRUE)

saveRDS(ATAC, file = "ATAC_with_predicted_labels.rds")
 

